<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¥ë°”êµ¬ë‹ˆ - Booking Fresh</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/common.css}">
  <link rel="stylesheet" th:href="@{/css/navbar.css}">

  <style>
    /* (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€) */
    .page-header { margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #00B992; }
    .page-header h2 { color: #343a40; font-weight: 700; }
    .cart-container { max-width: 1200px; margin: 0 auto; padding: 40px 15px; display: flex; gap: 32px; align-items: flex-start; }
    .cart-items { flex: 3; display: flex; flex-direction: column; gap: 16px; }
    .cart-card { display: flex; align-items: center; background-color: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); padding: 20px; border: 1px solid #e9ecef; transition: all 0.3s; }
    .cart-card:hover { box-shadow: 0 4px 12px rgba(0, 185, 146, 0.15); border-color: #00B992; }
    .cart-card img { width: 120px; height: 120px; object-fit: cover; border-radius: 8px; margin-right: 24px; }
    .cart-info { flex: 1; display: flex; flex-direction: column; gap: 8px; }
    .cart-info h3 { font-size: 1.1rem; font-weight: 600; margin: 0; color: #343a40; }
    .cart-info .product-weight { font-size: 0.9rem; color: #6c757d; }
    .cart-info .product-price { font-size: 1.1rem; font-weight: 700; color: #00B992; margin-top: 4px; }

    /* ìˆ˜ëŸ‰ ì¡°ì ˆ ìŠ¤íƒ€ì¼ ìœ ì§€ */
    .cart-actions { display: flex; align-items: center; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    .quantity-control { display: flex; align-items: center; gap: 8px; border: 1px solid #dee2e6; border-radius: 8px; padding: 4px 8px; background-color: #f8f9fa; }
    .quantity-btn { background-color: transparent; border: none; color: #00B992; font-size: 1.2rem; font-weight: 600; cursor: pointer; padding: 4px 8px; transition: all 0.3s; line-height: 1; }
    .quantity-btn:hover { background-color: #e7f8f5; border-radius: 4px; }
    .quantity-input { width: 50px; text-align: center; border: none; background: transparent; font-weight: 600; font-size: 1rem; color: #343a40; }

    .apply-button { padding: 6px 16px; background-color: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.3s; }
    .apply-button:hover { background-color: #5a6268; }

    .delete-button { padding: 6px 16px; background-color: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.3s; }
    .delete-button:hover { background-color: #c82333; transform: translateY(-1px); }

    /* [ì¶”ê°€] ì¿ í° ë²„íŠ¼ ë° ì •ë³´ ìŠ¤íƒ€ì¼ */
    .coupon-btn {
      padding: 6px 16px;
      background-color: #00B992; /* ë©”ì¸ ì»¬ëŸ¬ */
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .coupon-btn:hover { background-color: #009977; transform: translateY(-1px); }

    .applied-coupon-badge {
      display: inline-block;
      background-color: #e7f8f5;
      color: #00B992;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
      border: 1px solid #00B992;
    }

    /* [ì¶”ê°€] ëª¨ë‹¬ ë‚´ ì¿ í° ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .coupon-option {
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .coupon-option:hover { background-color: #f8f9fa; }
    .coupon-option.active { background-color: #e7f8f5; border-color: #00B992; }

    /* (ê¸°ì¡´ ìš”ì•½/ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ ìœ ì§€) */
    .cart-summary { flex: 1; position: sticky; top: 20px; background-color: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); padding: 24px; border: 1px solid #e9ecef; }
    .cart-summary h3 { font-size: 1.2rem; font-weight: 600; margin-bottom: 1.5rem; color: #343a40; padding-bottom: 0.75rem; border-bottom: 2px solid #f8f9fa; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.95rem; color: #495057; }
    .summary-row.total { margin-top: 16px; padding-top: 16px; border-top: 2px solid #dee2e6; font-size: 1.2rem; font-weight: 700; color: #00B992; }
    .checkout-button { width: 100%; padding: 14px; background-color: #00B992; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: 600; margin-top: 20px; transition: all 0.3s; }
    .checkout-button:hover { background-color: #009977; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 185, 146, 0.3); }
    .checkout-button:disabled { background-color: #6c757d; cursor: not-allowed; transform: none; }
    .empty-cart { text-align: center; padding: 80px 20px; background-color: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); }
    .empty-cart h3 { color: #6c757d; margin-bottom: 16px; }
    .empty-cart a { display: inline-block; padding: 12px 32px; background-color: #00B992; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.3s; }
    .empty-cart a:hover { background-color: #009977; transform: translateY(-2px); }
    @media (max-width: 992px) { .cart-container { flex-direction: column; } .cart-summary { position: static; width: 100%; } }
    @media (max-width: 576px) { .cart-card { flex-direction: column; text-align: center; } .cart-card img { margin-right: 0; margin-bottom: 16px; } }
  </style>
</head>
<body>

<div th:replace="~{fragments/navbar :: headerFragment}"></div>

<main class="cart-container">

  <section class="cart-items" id="cartItems">
    <div class="text-center p-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
      </div>
    </div>
  </section>

  <aside class="cart-summary">
    <h3>ì£¼ë¬¸ ìš”ì•½</h3>
    <div class="summary-row">
      <span>ì´ ìƒí’ˆ ê¸ˆì•¡</span>
      <span id="summary-subtotal">â‚©0</span>
    </div>
    <div class="summary-row text-danger">
      <span>ì¿ í° í• ì¸</span>
      <span id="summary-discount">â‚©0</span>
    </div>
    <div class="summary-row total">
      <span>ì´ ê²°ì œ ê¸ˆì•¡</span>
      <span id="totalPrice">â‚©0</span>
    </div>
    <button id="checkoutBtn" class="checkout-button">êµ¬ë§¤í•˜ê¸°</button>
  </aside>

</main>

<div class="modal fade" id="couponModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ì¿ í° ì ìš©</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="modal-coupon-list" class="list-group">
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script type="module" th:src="@{/js/navbar-auth.js}"></script>
<script type="module">
  import { fetchWithAuth } from '/js/common-api.js';

  let cartData = null;
  let couponModal = null;
  let currentCartItemId = null; // í˜„ì¬ ì¿ í°ì„ ì ìš©í•˜ë ¤ëŠ” ì¹´íŠ¸ ì•„ì´í…œ ID

  // ìˆ«ì íŒŒì‹± í—¬í¼ í•¨ìˆ˜ (NaN ë°©ì§€)
  function parseCurrency(value) {
    if (typeof value === 'number') return value;
    if (!value) return 0;
    const stringValue = String(value).replace(/,/g, '');
    const numberValue = parseFloat(stringValue);
    return isNaN(numberValue) ? 0 : numberValue;
  }

  // í˜ì´ì§€ ë¡œë“œ
  document.addEventListener("DOMContentLoaded", async () => {
    // ëª¨ë‹¬ ì´ˆê¸°í™”
    couponModal = new bootstrap.Modal(document.getElementById('couponModal'));
    await loadCart();
  });

  // ì¥ë°”êµ¬ë‹ˆ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadCart() {
    try {
      const response = await fetchWithAuth("/api/cart/detail", { method: "GET" });
      if (response.ok) {
        cartData = await response.json();
        renderCart(cartData);
      } else if (response.status === 401) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "/login";
      } else {
        throw new Error("ì¥ë°”êµ¬ë‹ˆë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }
    } catch (err) {
      console.error("ì¥ë°”êµ¬ë‹ˆ ë¡œë“œ ì˜¤ë¥˜:", err);
      alert("ì„¸ì…˜ ë§Œë£Œ ë˜ëŠ” ì˜¤ë¥˜ ë°œìƒ.");
    }
  }

  // ì¥ë°”êµ¬ë‹ˆ ë Œë”ë§
  function renderCart(cart) {
    const itemsContainer = document.getElementById("cartItems");

    if (!cart.items || cart.items.length === 0) {
      itemsContainer.innerHTML = `
                <div class="empty-cart">
                  <h3>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</h3>
                  <p style="color: #6c757d; margin-bottom: 24px;">ì›í•˜ì‹œëŠ” ìƒí’ˆì„ ë‹´ì•„ë³´ì„¸ìš”!</p>
                  <a href="/products">ì‡¼í•‘ ê³„ì†í•˜ê¸°</a>
                </div>`;
      document.getElementById("summary-subtotal").textContent = "â‚©0";
      document.getElementById("summary-discount").textContent = "â‚©0";
      document.getElementById("totalPrice").textContent = "â‚©0";
      document.getElementById("checkoutBtn").disabled = true;
      return;
    }

    // ìƒí’ˆ ëª©ë¡ ë Œë”ë§
    itemsContainer.innerHTML = cart.items.map(item => {
      const originalPrice = parseCurrency(item.price);
      // appliedCouponì´ ìˆìœ¼ë©´ í• ì¸ê°€ ì ìš©, ì—†ìœ¼ë©´ ì •ê°€
      const finalPrice = item.priceAfterDiscount ? parseCurrency(item.priceAfterDiscount) : originalPrice;
      const totalPrice = finalPrice * item.quantity;

      // ì ìš©ëœ ì¿ í° ì •ë³´ HTML
      let couponInfoHtml = '';
      if (item.appliedCoupon) {
        couponInfoHtml = `<div class="applied-coupon-badge">ğŸŸ ${item.appliedCoupon.name} ì ìš©ì¤‘</div>`;
      }

      return `
            <div class="cart-card" data-cart-item-id="${item.cartItemId}">
                <img src="${item.photoUrl}" alt="${item.name}">
                <div class="cart-info">
                    <h3>${item.name}</h3>
                    <p class="product-weight">${item.weightPieces || ''}</p>

                    ${couponInfoHtml}

                    <div class="d-flex align-items-center gap-2">
                         ${item.appliedCoupon ? `<span style="text-decoration: line-through; color: #999; font-size: 0.9rem;">â‚©${originalPrice.toLocaleString()}</span>` : ''}
                         <p class="product-price">â‚©${finalPrice.toLocaleString()}</p>
                    </div>

                    <div class="cart-actions">
                        <div class="quantity-control">
                            <button type="button" class="quantity-btn" onclick="changeQuantity(this, -1)">âˆ’</button>
                            <input type="text" class="quantity-input" value="${item.quantity}" readonly/>
                            <button type="button" class="quantity-btn" onclick="changeQuantity(this, 1)">+</button>
                        </div>
                        <button class="apply-button" data-product-id="${item.productId}">ìˆ˜ëŸ‰ ë³€ê²½</button>

                        <button class="coupon-btn"
                                data-product-id="${item.productId}"
                                data-cart-item-id="${item.cartItemId}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                              <path d="M2.5 3A1.5 1.5 0 0 0 1 4.5v.3c.601.212 1 .803 1 1.5s-.399 1.288-1 1.5v.3A1.5 1.5 0 0 0 2.5 9h11a1.5 1.5 0 0 0 1.5-1.5v-.3c-.601-.212-1-.803-1-1.5s.399-1.288 1-1.5v-.3A1.5 1.5 0 0 0 13.5 3z"/>
                            </svg>
                            ì¿ í°
                        </button>

                        <button class="delete-button" data-product-id="${item.productId}">ì‚­ì œ</button>
                    </div>
                </div>
                <div class="ms-auto text-end">
                    <h5 style="color: #333;">â‚©${totalPrice.toLocaleString()}</h5>
                </div>
            </div>`;
    }).join("");

    // ìš”ì•½ ì •ë³´ í‘œì‹œ (API ì‘ë‹µ í•„ë“œëª…ì— ë§ì¶° ìˆ˜ì •)
    document.getElementById("summary-subtotal").textContent = `â‚©${parseCurrency(cart.totalAmount).toLocaleString()}`;
    document.getElementById("summary-discount").textContent = `- â‚©${parseCurrency(cart.totalDiscount).toLocaleString()}`;
    document.getElementById("totalPrice").textContent = `â‚©${parseCurrency(cart.finalAmount).toLocaleString()}`;
    document.getElementById("checkoutBtn").disabled = false;

    attachEventListeners();
  }

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  function attachEventListeners() {
    // ì‚­ì œ, ìˆ˜ëŸ‰ ë³€ê²½ ê¸°ì¡´ ë¡œì§ì€ ìœ ì§€í•˜ê³ ...

    // 1. ì¿ í° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.querySelectorAll(".coupon-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const productId = btn.dataset.productId;
        const cartItemId = btn.dataset.cartItemId;
        openCouponModal(productId, cartItemId);
      });
    });

    // (ê¸°ì¡´) ìˆ˜ëŸ‰ ë³€ê²½ ë²„íŠ¼
    document.querySelectorAll(".apply-button").forEach(btn => {
      btn.addEventListener("click", async () => {
        const productId = btn.dataset.productId;
        const card = btn.closest('.cart-card');
        const quantity = parseInt(card.querySelector(".quantity-input").value);
        if (quantity < 1) { alert("ìµœì†Œ 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."); return; }

        try {
          const res = await fetchWithAuth(`/api/cart/update?productId=${productId}&quantity=${quantity}`, { method: "PATCH" });
          if (res.ok) loadCart();
          else alert("ìˆ˜ëŸ‰ ë³€ê²½ ì‹¤íŒ¨");
        } catch (e) { console.error(e); }
      });
    });

    // (ê¸°ì¡´) ì‚­ì œ ë²„íŠ¼
    document.querySelectorAll(".delete-button").forEach(btn => {
      btn.addEventListener("click", async () => {
        if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const productId = btn.dataset.productId;
        try {
          const res = await fetchWithAuth(`/api/cart/remove?productId=${productId}`, { method: "DELETE" });
          if (res.ok) loadCart();
          else alert("ì‚­ì œ ì‹¤íŒ¨");
        } catch (e) { console.error(e); }
      });
    });

    // (ê¸°ì¡´) êµ¬ë§¤í•˜ê¸° ë²„íŠ¼
    document.getElementById("checkoutBtn").addEventListener("click", async () => {
      const btn = document.getElementById("checkoutBtn");
      try {
        btn.disabled = true;
        btn.textContent = "ì£¼ë¬¸ ìƒì„± ì¤‘...";
        const res = await fetchWithAuth(`/orders/create?isReservation=false`, { method: "POST" });
        if (res.ok) {
          const order = await res.json();
          window.location.href = `/order/${order.orderId}`;
        } else {
          alert("ì£¼ë¬¸ ìƒì„± ì‹¤íŒ¨");
          btn.disabled = false;
        }
      } catch (err) {
        console.error(err);
        btn.disabled = false;
      }
    });
  }

  // ì¿ í° ëª¨ë‹¬ ì—´ê¸°
  async function openCouponModal(productId, cartItemId) {
    currentCartItemId = cartItemId;
    const listContainer = document.getElementById("modal-coupon-list");
    listContainer.innerHTML = `<div class="text-center p-3"><div class="spinner-border text-primary"></div></div>`;

    couponModal.show();

    try {
      // í•´ë‹¹ ìƒí’ˆì— ì ìš© ê°€ëŠ¥í•œ ì¿ í° ëª©ë¡ ì¡°íšŒ
      const response = await fetchWithAuth(`/api/coupons/applicable-to/${productId}`);
      const coupons = await response.json();

      // ë Œë”ë§
      renderCouponList(coupons);

    } catch (err) {
      console.error("ì¿ í° ë¡œë“œ ì‹¤íŒ¨:", err);
      listContainer.innerHTML = `<div class="p-3 text-danger">ì¿ í° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
    }
  }

  // ëª¨ë‹¬ ë‚´ë¶€ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
  function renderCouponList(coupons) {
    const listContainer = document.getElementById("modal-coupon-list");
    let html = '';

    // "ì¿ í° ì ìš© í•´ì œ" ì˜µì…˜
    html += `
            <a href="#" class="list-group-item list-group-item-action list-group-item-warning d-flex justify-content-between align-items-center"
               onclick="applyCoupon(null); return false;">
                <div>
                    <h6 class="mb-0">ì„ íƒ ì•ˆ í•¨ / ì ìš© í•´ì œ</h6>
                    <small>í˜„ì¬ ì ìš©ëœ ì¿ í°ì„ ì œê±°í•©ë‹ˆë‹¤.</small>
                </div>
                <span>ğŸ”„</span>
            </a>
        `;

    if (!coupons || coupons.length === 0) {
      html += `<div class="p-3 text-center text-muted">ì ìš© ê°€ëŠ¥í•œ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    } else {
      // ì¿ í° ëª©ë¡
      html += coupons.map(c => {
        const discountAmt = parseCurrency(c.calculatedDiscountAmount);
        const finalPrice = parseCurrency(c.finalPriceAfterDiscount);
        const alreadyUsed = c.isUsed;

        let statusBadge = '';
        if (c.isApplied) statusBadge = '<span class="badge bg-secondary ms-2">ë‹¤ë¥¸ ìƒí’ˆì— ì ìš©ì¤‘</span>';

        return `
                <a href="#" class="list-group-item list-group-item-action coupon-option"
                   onclick="applyCoupon(${c.userCouponId}); return false;">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${c.name} ${statusBadge}</h6>
                        <strong class="text-danger">-${discountAmt.toLocaleString()}ì›</strong>
                    </div>
                    <p class="mb-1 text-muted small">ìµœì¢…ê°€: <strong>â‚©${finalPrice.toLocaleString()}</strong></p>
                    <small class="text-muted">ì¡°ê±´: ${parseCurrency(c.minOrderAmount).toLocaleString()}ì› ì´ìƒ</small>
                </a>
                `;
      }).join('');
    }

    listContainer.innerHTML = html;
  }

  // ì¿ í° ì ìš© API í˜¸ì¶œ
  window.applyCoupon = async (userCouponId) => {
    if (!currentCartItemId) return;

    const actionName = userCouponId ? "ì ìš©" : "í•´ì œ";

    const body = {
      cartItemId: parseInt(currentCartItemId),
      userCouponId: userCouponId ? parseInt(userCouponId) : null
    };

    try {
      const response = await fetchWithAuth("/api/coupons/cart/item/coupon", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (response.ok) {
        alert(`ì¿ í°ì´ ${actionName}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        couponModal.hide();
        loadCart(); // ì¥ë°”êµ¬ë‹ˆ ì¬ì¡°íšŒ (ê°€ê²© ë°˜ì˜)
      } else {
        const msg = await response.text();
        alert(`ì¿ í° ${actionName} ì‹¤íŒ¨: ` + msg);
      }
    } catch (err) {
      console.error(err);
      alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  };

  // ì „ì—­ í•¨ìˆ˜ (ìˆ˜ëŸ‰ ë³€ê²½ìš©)
  window.changeQuantity = (btn, delta) => {
    const input = btn.parentElement.querySelector(".quantity-input");
    let value = parseInt(input.value) + delta;
    if (value < 1) value = 1;
    input.value = value;
  };
</script>

</body>
</html>