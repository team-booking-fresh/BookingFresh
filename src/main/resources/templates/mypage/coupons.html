<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>내 쿠폰 - BOOKING FRESH</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet" th:href="@{/css/common.css}">
  <link rel="stylesheet" th:href="@{/css/navbar.css}">

  <style>
    .coupons-container {
      max-width: 1000px;
      margin: 40px auto;
      padding: 20px;
    }

    .page-header {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #00B992;
    }

    .page-header h2 {
      color: #343a40;
      font-weight: 700;
    }

    .page-header p {
      color: #6c757d;
      margin: 0;
    }

    /* 탭 스타일 */
    .coupon-tabs {
      display: flex;
      gap: 1rem;
      border-bottom: 2px solid #e9ecef;
    }

    .tab-btn {
      background: none;
      border: none;
      padding: 1rem 1.5rem;
      font-size: 1.1rem;
      font-weight: 600;
      color: #6c757d;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
    }

    .tab-btn.active {
      color: #00B992;
      border-bottom-color: #00B992;
    }

    .tab-btn:hover {
      color: #00B992;
    }

    /* 쿠폰 카드 스타일 */
    .coupon-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 2px solid #e9ecef;
      display: flex;
      gap: 1.5rem;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .coupon-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 5px;
      height: 100%;
      background: #00B992;
    }

    .coupon-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 185, 146, 0.2);
      border-color: #00B992;
    }

    .coupon-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #00B992 0%, #00d4aa 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .coupon-icon svg {
      width: 40px;
      height: 40px;
      fill: white;
    }

    .coupon-content {
      flex: 1;
    }

    .coupon-name {
      font-size: 1.2rem;
      font-weight: 700;
      color: #343a40;
      margin-bottom: 0.5rem;
    }

    .coupon-discount {
      font-size: 1.5rem;
      font-weight: 800;
      color: #00B992;
      margin-bottom: 0.5rem;
    }

    .coupon-condition {
      font-size: 0.9rem;
      color: #6c757d;
      margin-bottom: 0.5rem;
    }

    .coupon-categories {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .category-badge {
      background-color: #e7f8f5;
      color: #00B992;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .coupon-code {
      font-family: 'Courier New', monospace;
      background-color: #f8f9fa;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #495057;
      border: 1px dashed #dee2e6;
      display: inline-block;
      margin-top: 0.5rem;
    }

    /* 사용완료 쿠폰 스타일 */
    .coupon-card.used {
      opacity: 0.6;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    .coupon-card.used::before {
      background: #6c757d;
    }

    .coupon-card.used .coupon-icon {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }

    .used-badge {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background-color: #dc3545;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    /* 빈 상태 */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      fill: #dee2e6;
      margin-bottom: 1rem;
    }

    .empty-state h4 {
      color: #6c757d;
      margin-bottom: 0.5rem;
    }

    .empty-state p {
      color: #adb5bd;
    }

    /* 로딩 */
    .loading-spinner {
      text-align: center;
      padding: 3rem;
    }

    /* 통계 카드 */
    .stats-card {
      background-color: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-around;
      gap: 1rem;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      color: #00B992;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #6c757d;
      margin-top: 0.25rem;
    }
  </style>
</head>
<body>

<div th:replace="~{fragments/navbar :: headerFragment}"></div>

<main class="main-wrapper">
  <div class="container coupons-container">

    <div class="page-header">
      <h2>내 쿠폰</h2>
      <p>사용 가능한 쿠폰을 확인하세요</p>
    </div>

    <div class="stats-card" id="stats-card">
      <div class="stat-item">
        <div class="stat-value" id="total-coupons">-</div>
        <div class="stat-label">전체 쿠폰</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="available-coupons">-</div>
        <div class="stat-label">사용 가능</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="used-coupons">-</div>
        <div class="stat-label">사용 완료</div>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
      <div class="coupon-tabs">
        <button class="tab-btn active" data-tab="all">전체</button>
        <button class="tab-btn" data-tab="available">사용 가능</button>
        <button class="tab-btn" data-tab="used">사용 완료</button>
      </div>

      <div class="category-filter-wrapper">
        <select id="category-filter" class="form-select" style="width: 200px;">
          <option value="all">전체 카테고리</option>
        </select>
      </div>
    </div>


    <div id="coupon-list">
      <div class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">쿠폰 로딩 중...</span>
        </div>
      </div>
    </div>

  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module" th:src="@{/js/common-api.js}"></script>
<script type="module" th:src="@{/js/navbar-auth.js}"></script>

<script type="module">
  import { fetchWithAuth } from '/js/common-api.js';

  let allCoupons = [];
  let currentFilter = 'all';

  // 할인 금액 계산 함수
  function getDiscountDisplay(discountValue) {
    const value = parseFloat(discountValue);

    if (value > 100) {
      // 고정 금액 할인
      return `${value.toLocaleString()}원`;
    } else {
      // 퍼센트 할인
      return `${value}%`;
    }
  }

  //  DTO 필드명에 맞게 수정
  function createCouponCard(coupon) {
    const isUsed = coupon.isUsed;
    const usedClass = isUsed ? 'used' : '';
    const usedBadge = isUsed ? '<span class="used-badge">사용완료</span>' : '';

    const categories = coupon.applicableCategories && coupon.applicableCategories.length > 0
            ? coupon.applicableCategories.map(cat =>
                    `<span class="category-badge">${cat.name}</span>`
            ).join('')
            : '<span class="category-badge">전체 상품</span>';

    const minOrderAmount = parseFloat(coupon.minOrderAmount);
    const minOrderText = minOrderAmount > 0
            ? `${minOrderAmount.toLocaleString()}원 이상 구매시`
            : '최소 주문 금액 없음';

    return `
                <div class="coupon-card ${usedClass}">
                    ${usedBadge}
                    <div class="coupon-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M2.5 3A1.5 1.5 0 0 0 1 4.5v.3c.601.212 1 .803 1 1.5s-.399 1.288-1 1.5v.3A1.5 1.5 0 0 0 2.5 9h11a1.5 1.5 0 0 0 1.5-1.5v-.3c-.601-.212-1-.803-1-1.5s.399-1.288 1-1.5v-.3A1.5 1.5 0 0 0 13.5 3z"/>
                        </svg>
                    </div>
                    <div class="coupon-content">
                        <div class="coupon-name">${coupon.name}</div>
                        <div class="coupon-discount">${getDiscountDisplay(coupon.discountValue)} 할인</div>
                        <div class="coupon-condition">${minOrderText}</div>
                        <div class="coupon-categories">${categories}</div>
                        <div class="coupon-code">코드: ${coupon.code}</div>
                    </div>
                </div>
            `;
  }

  // 카테고리 필터 드롭다운 채우기 함수
  function populateCategoryFilter(coupons) {
    const filterSelect = document.getElementById('category-filter');
    const categories = new Map(); // 중복 제거를 위해 Map 사용

    // "전체 상품" 카테고리 (카테고리 목록이 비어있는 경우)
    let hasGlobalCoupon = false;

    coupons.forEach(coupon => {
      // DTO의 applicableCategories 사용
      if (coupon.applicableCategories && coupon.applicableCategories.length > 0) {
        coupon.applicableCategories.forEach(cat => {
          if (!categories.has(cat.id)) {
            categories.set(cat.id, cat);
          }
        });
      } else {
        // 적용 카테고리가 없는 쿠폰 (전체 상품)
        hasGlobalCoupon = true;
      }
    });

    // "전체 상품" 쿠폰이 있을 경우에만 옵션 추가
    if (hasGlobalCoupon) {
      const option = document.createElement('option');
      option.value = 'global';
      option.textContent = '전체 상품';
      filterSelect.appendChild(option);
    }

    // Map의 value들로 <option> 태그 생성
    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat.id;
      option.textContent = cat.name;
      filterSelect.appendChild(option);
    });
  }

  // 쿠폰 목록 렌더링
  function renderCoupons(filter = 'all') {
    const couponList = document.getElementById('coupon-list');

    const selectedCategoryId = document.getElementById('category-filter').value;

    let filteredCoupons = allCoupons;

    // 사용 여부 필터링
    if (filter === 'available') {
      filteredCoupons = allCoupons.filter(c => !c.isUsed);
    } else if (filter === 'used') {
      filteredCoupons = allCoupons.filter(c => c.isUsed);
    }

    // 카테고리 필터링
    if (selectedCategoryId !== 'all') {
      filteredCoupons = filteredCoupons.filter(coupon => {
        const categories = coupon.applicableCategories;
        if (selectedCategoryId === 'global') {
          return !categories || categories.length === 0;
        }

        return categories && categories.some(cat => cat.id == selectedCategoryId);
      });
    }


    // 빈 상태 처리
    if (filteredCoupons.length === 0) {
      const emptyMessage = filter === 'all'
              ? '보유한 쿠폰이 없습니다'
              : filter === 'available'
                      ? '사용 가능한 쿠폰이 없습니다'
                      : '사용 완료된 쿠폰이 없습니다';

      couponList.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M2.5 3A1.5 1.5 0 0 0 1 4.5v.3c.601.212 1 .803 1 1.5s-.399 1.288-1 1.5v.3A1.5 1.5 0 0 0 2.5 9h11a1.5 1.5 0 0 0 1.5-1.5v-.3c-.601-.212-1-.803-1-1.5s.399-1.288 1-1.5v-.3A1.5 1.5 0 0 0 13.5 3z"/>
                        </svg>
                        <h4>${emptyMessage}</h4>
                        <p>상품 구매 시 다양한 쿠폰을 받을 수 있습니다</p>
                    </div>
                `;
      return;
    }

    // 쿠폰 카드 렌더링
    couponList.innerHTML = filteredCoupons.map(createCouponCard).join('');
  }

  // 통계 업데이트
  function updateStats() {
    const total = allCoupons.length;
    const available = allCoupons.filter(c => !c.isUsed).length;
    const used = allCoupons.filter(c => c.isUsed).length;

    document.getElementById('total-coupons').textContent = total;
    document.getElementById('available-coupons').textContent = available;
    document.getElementById('used-coupons').textContent = used;
  }

  // 사용자 쿠폰 로드
  async function loadUserCoupons() {
    try {
      const couponsResponse = await fetchWithAuth(`/api/coupons/my`, {
        method: 'GET'
      });

      allCoupons = await couponsResponse.json();

      // 카테고리 필터 채우기
      populateCategoryFilter(allCoupons);

      // 렌더링 및 통계 업데이트
      renderCoupons(currentFilter);
      updateStats();

    } catch (error) {
      console.error('쿠폰 로드 실패:', error);
      document.getElementById('coupon-list').innerHTML = `
                    <div class="empty-state">
                        <h4>쿠폰을 불러올 수 없습니다</h4>
                        <p class="text-danger">${error.message}</p>
                    </div>
                `;
    }
  }

  // 탭 전환 이벤트
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // 활성 탭 변경
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');

      // 필터 적용
      currentFilter = this.dataset.tab;
      renderCoupons(currentFilter);
    });
  });

  // 카테고리 필터 이벤트 리스너
  document.getElementById('category-filter').addEventListener('change', function() {
    // 탭 필터(currentFilter)는 그대로 둔 채 렌더링만 다시 호출
    renderCoupons(currentFilter);
  });


  // 페이지 로드 시 실행
  document.addEventListener('DOMContentLoaded', loadUserCoupons);
</script>

</body>
</html>