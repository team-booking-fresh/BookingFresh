<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì£¼ë¬¸ ë‚´ì—­ - BOOKING FRESH</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- ê³µí†µ CSS -->
  <link rel="stylesheet" th:href="@{/css/common.css}">
  <link rel="stylesheet" th:href="@{/css/navbar.css}">

  <style>
    .orders-container {
      max-width: 1000px;
      margin: 40px auto;
      padding: 20px;
    }

    .page-header {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #00B992;
    }

    .page-header h2 {
      color: #343a40;
      font-weight: 700;
    }

    /* í•„í„° íƒ­ */
    .filter-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid #e9ecef;
    }

    .filter-tab {
      background: none;
      border: none;
      padding: 1rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: #6c757d;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
    }

    .filter-tab.active {
      color: #00B992;
      border-bottom-color: #00B992;
    }

    /* ì£¼ë¬¸ ì¹´ë“œ */
    .order-card {
      background-color: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 2px solid #e9ecef;
      transition: all 0.3s;
      cursor: pointer;
    }

    .order-card:hover {
      border-color: #00B992;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 185, 146, 0.2);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e9ecef;
    }

    .order-id {
      font-size: 1.1rem;
      font-weight: 700;
      color: #343a40;
    }

    .order-date {
      color: #6c757d;
      font-size: 0.9rem;
    }

    .order-content {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1rem;
    }

    .order-image {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .order-image svg {
      width: 40px;
      height: 40px;
      fill: #6c757d;
    }

    .order-details {
      flex: 1;
    }

    .order-items-summary {
      font-size: 1rem;
      color: #495057;
      margin-bottom: 0.5rem;
    }

    .order-price {
      font-size: 1.3rem;
      font-weight: 800;
      color: #00B992;
    }

    .order-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 1rem;
      border-top: 1px solid #e9ecef;
    }

    .delivery-info {
      color: #6c757d;
      font-size: 0.9rem;
    }

    /* ìƒíƒœ ë°°ì§€ */
    .status-badge {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .status-pending {
      background-color: #fff3cd;
      color: #856404;
    }

    .status-completed {
      background-color: #d1e7dd;
      color: #0f5132;
    }

    .status-cancelled {
      background-color: #f8d7da;
      color: #842029;
    }

    /* ë°°ì†¡ íƒ€ì… ë°°ì§€ */
    .delivery-type {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background-color: #e7f8f5;
      color: #00B992;
      border-radius: 15px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    /* ë¹ˆ ìƒíƒœ */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      fill: #dee2e6;
      margin-bottom: 1rem;
    }

    .empty-state h4 {
      color: #6c757d;
      margin-bottom: 0.5rem;
    }

    /* ë¡œë”© */
    .loading-spinner {
      text-align: center;
      padding: 3rem;
    }
  </style>
</head>
<body>

<!-- ë„¤ë¹„ë°” í¬í•¨ -->
<div th:replace="~{fragments/navbar :: headerFragment}"></div>

<!-- ë©”ì¸ ì»¨í…ì¸  -->
<main class="main-wrapper">
  <div class="container orders-container">

    <div class="page-header">
      <h2>ì£¼ë¬¸ ë‚´ì—­</h2>
      <p class="text-muted mb-0">ì „ì²´ ì£¼ë¬¸ ë‚´ì—­ì„ í™•ì¸í•˜ì„¸ìš”</p>
    </div>

    <!-- í•„í„° íƒ­ -->
    <div class="filter-tabs">
      <button class="filter-tab active" data-status="all">ì „ì²´</button>
      <button class="filter-tab" data-status="PENDING">ëŒ€ê¸°ì¤‘</button>
      <button class="filter-tab" data-status="COMPLETED">ì™„ë£Œ</button>
      <button class="filter-tab" data-status="CANCELLED">ì·¨ì†Œë¨</button>
    </div>

    <!-- ì£¼ë¬¸ ëª©ë¡ -->
    <div id="order-list">
      <!-- ë¡œë”© ì¤‘ -->
      <div class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">ì£¼ë¬¸ ë‚´ì—­ ë¡œë”© ì¤‘...</span>
        </div>
      </div>
    </div>

  </div>
</main>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- ê³µí†µ JS -->
<script type="module" th:src="@{/js/common-api.js}"></script>
<script type="module" th:src="@{/js/navbar-auth.js}"></script>

<!-- ì£¼ë¬¸ ëª©ë¡ ìŠ¤í¬ë¦½íŠ¸ -->
<script type="module">
  import { fetchWithAuth } from '/js/common-api.js';

  let allOrders = [];
  let currentFilter = 'all';

  // ìƒíƒœ ë°°ì§€ HTML ìƒì„±
  function getStatusBadgeHtml(status) {
    const statusMap = {
      'PENDING': '<span class="status-badge status-pending">ëŒ€ê¸°ì¤‘</span>',
      'COMPLETED': '<span class="status-badge status-completed">ì™„ë£Œ</span>',
      'CANCELLED': '<span class="status-badge status-cancelled">ì·¨ì†Œë¨</span>'
    };
    return statusMap[status] || '<span class="status-badge">ì•Œ ìˆ˜ ì—†ìŒ</span>';
  }

  // ì£¼ë¬¸ ì¹´ë“œ HTML ìƒì„±
  function createOrderCard(order) {
    const statusBadge = getStatusBadgeHtml(order.status);
    const deliveryType = order.isReservation ? 'ì˜ˆì•½ ë°°ì†¡' : 'ì¦‰ì‹œ ë°°ì†¡';
    const orderDate = new Date(order.createdAt).toLocaleDateString('ko-KR');
    const deliveryDate = new Date(order.deliveryDate).toLocaleDateString('ko-KR');

    const itemsText = order.items.length > 1
            ? `${order.items[0].productName} ì™¸ ${order.items.length - 1}ê°œ`
            : order.items[0].productName;

    const deliverySlotText = {
      'MORNING': 'ì˜¤ì „ (08:00-12:00)',
      'AFTERNOON': 'ì˜¤í›„ (12:00-18:00)',
      'EVENING': 'ì €ë… (18:00-22:00)'
    }[order.deliverySlot] || '';

    return `
                <div class="order-card" onclick="location.href='/mypage/orders/${order.orderId}'">
                    <div class="order-header">
                        <div>
                            <span class="order-id">ì£¼ë¬¸ë²ˆí˜¸: ${order.orderId}</span>
                            ${statusBadge}
                            <span class="delivery-type">${deliveryType}</span>
                        </div>
                        <div class="order-date">${orderDate}</div>
                    </div>

                    <div class="order-content">
                        <div class="order-image">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5M5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4m7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4"/>
                            </svg>
                        </div>
                        <div class="order-details">
                            <div class="order-items-summary">${itemsText}</div>
                            <div class="order-price">${parseInt(order.finalCost).toLocaleString()}ì›</div>
                            ${order.totalPrice !== order.finalCost ? `<small class="text-muted text-decoration-line-through">${parseInt(order.totalPrice).toLocaleString()}ì›</small>` : ''}
                        </div>
                    </div>

                    <div class="order-footer">
                        <div class="delivery-info">
                            ğŸ“¦ ë°°ì†¡ ì˜ˆì •: ${deliveryDate} ${deliverySlotText}
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#6c757d" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708"/>
                        </svg>
                    </div>
                </div>
            `;
  }

  // ì£¼ë¬¸ ëª©ë¡ ë Œë”ë§
  function renderOrders(filter = 'all') {
    const orderList = document.getElementById('order-list');

    let filteredOrders = allOrders;

    // í•„í„°ë§
    if (filter !== 'all') {
      filteredOrders = allOrders.filter(o => o.status === filter);
    }

    // ë¹ˆ ìƒíƒœ ì²˜ë¦¬
    if (filteredOrders.length === 0) {
      const emptyMessage = filter === 'all'
              ? 'ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤'
              : `${filter === 'PENDING' ? 'ëŒ€ê¸°ì¤‘ì¸' : filter === 'COMPLETED' ? 'ì™„ë£Œëœ' : 'ì·¨ì†Œëœ'} ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤`;

      orderList.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5M5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4m7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4"/>
                        </svg>
                        <h4>${emptyMessage}</h4>
                        <p>ìƒí’ˆì„ ì£¼ë¬¸í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                    </div>
                `;
      return;
    }

    // ì£¼ë¬¸ ì¹´ë“œ ë Œë”ë§
    orderList.innerHTML = filteredOrders.map(createOrderCard).join('');
  }

  // ì£¼ë¬¸ ëª©ë¡ ë¡œë“œ
  async function loadOrders() {
    try {

      const ordersResponse = await fetchWithAuth(`/orders/my`, {
        method: 'GET'
      });

      allOrders = await ordersResponse.json();

      // ë Œë”ë§
      renderOrders(currentFilter);

    } catch (error) {
      console.error('ì£¼ë¬¸ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
      document.getElementById('order-list').innerHTML = `
                    <div class="empty-state">
                        <h4>ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h4>
                        <p class="text-danger">${error.message}</p>
                    </div>
                `;
    }
  }

  // í•„í„° íƒ­ ì´ë²¤íŠ¸
  document.querySelectorAll('.filter-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      // í™œì„± íƒ­ ë³€ê²½
      document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');

      // í•„í„° ì ìš©
      currentFilter = this.dataset.status;
      renderOrders(currentFilter);
    });
  });

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
  document.addEventListener('DOMContentLoaded', loadOrders);
</script>

</body>
</html>