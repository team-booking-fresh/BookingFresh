<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title th:text="${product.name} + ' - Booking Fresh'">ìƒí’ˆ ìƒì„¸</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/common.css}">
  <link rel="stylesheet" th:href="@{/css/navbar.css}">

  <style>
    /* ìƒí’ˆ ìƒì„¸ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
    .product-detail-layout {
      margin-top: 40px;
    }

    .product-image {
      width: 100%;
      height: 450px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid #e9ecef;
    }

    .product-info h2 {
      font-weight: 700;
      font-size: 2rem;
      color: #343a40;
      margin-bottom: 0.5rem;
    }
    .product-info .weight {
      font-size: 1rem;
      color: #6c757d;
      margin-bottom: 1.5rem;
    }
    .product-info .price {
      font-size: 2.25rem;
      font-weight: 800;
      color: #00B992;
      margin-bottom: 2rem;
    }

    /* "ì›ë³¸ ì½”ë“œ"ì˜ ë¬¶ìŒ ì˜µì…˜ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    .bundle-options {
      margin-bottom: 2rem;
      padding: 1rem;
      background-color: #f8f9fa;
      border-radius: 8px;
    }
    .bundle-options label {
      font-weight: 600;
      margin-right: 1rem;
    }
    .bundle-options #bundle-price {
      font-size: 1.25rem;
      font-weight: 700;
      color: #343a40;
      margin-top: 1rem;
    }

    /* ìˆ˜ëŸ‰ ë° ì¥ë°”êµ¬ë‹ˆ ë²„íŠ¼ */
    .purchase-actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      border-top: 1px solid #e9ecef;
      padding-top: 2rem;
    }
    .quantity-input {
      width: 80px;
      text-align: center;
    }
    .btn-cart {
      flex-grow: 1;
      background-color: #00B992;
      color: white;
      font-weight: 600;
      padding: 0.75rem;
    }
    .btn-cart:hover {
      background-color: #00897b;
      color: white;
    }
    .btn-wishlist {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      color: #dc3545;
      padding: 0.75rem 1rem;
    }
    .btn-wishlist:hover {
      background-color: #fdd;
    }
    .btn-wishlist.active {
      background-color: #dc3545;
      color: white;
    }

    .coupon-section {
      margin-top: 2.5rem;
    }
    .coupon-section h5 {
      color: #343a40;
      font-weight: 700;
      padding-bottom: 1rem;
      border-bottom: 2px solid #e9ecef;
    }
    .coupon-list-item {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .coupon-info .name {
      font-weight: 600;
      color: #00B992;
    }
    .coupon-info .condition {
      font-size: 0.85rem;
      color: #6c757d;
    }
    .coupon-discount .final-price {
      font-size: 1.1rem;
      font-weight: 700;
      color: #343a40;
    }
  </style>
</head>
<body>

<div th:replace="~{fragments/navbar :: headerFragment}"></div>

<main class="container main-wrapper">

  <div class="row product-detail-layout">

    <div class="col-lg-5">
      <img th:src="${product.photoUrl}" alt="ìƒí’ˆì‚¬ì§„" class="product-image">
    </div>

    <div class="col-lg-7">
      <div class="product-info">

        <h2 th:text="${product.name}">ìƒí’ˆëª…</h2>
        <p class="weight" th:text="${product.weightPieces}">ì¤‘ëŸ‰</p>
        <div classs="price" th:text="'â‚©' + ${#numbers.formatInteger(product.price, 0, 'COMMA')}">ê°€ê²©</div>

        <section class="bundle-options">
          <label for="bundle">ë¬¶ìŒ ì„ íƒ:</label>
          <select id="bundle" name="bundle" class="form-select" style="width: auto; display: inline-block;">
            <option value="1">1ê°œ</option>
            <option value="2">2ê°œ</option>
            <option value="3">3ê°œ</option>
            <option value="6">6ê°œ</option>
          </select>
          <p id="bundle-price" class="mb-0">ì´ ê°€ê²©: â‚©...</p> </section>

        <div class="purchase-actions">
          <button type="button" class="btn btn-wishlist" id="wishlist-btn" title="ì°œí•˜ê¸°">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/>
            </svg>
          </button>

          <input type="number" id="quantity" name="quantity" class="form-control quantity-input" min="1" value="1">

          <button type="button" class="btn btn-cart" id="addToCartBtn" th:attr="data-product-id=${product.id}">
            ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
          </button>
        </div>

        <div class="coupon-section" th:if="${isLoggedIn}">
          <h5>ğŸ ì ìš© ê°€ëŠ¥ ì¿ í°</h5>
          <div id="coupon-list-container">
            <div class="text-center p-3">
              <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">ì¿ í° ë¡œë”© ì¤‘...</span>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script type="module" th:src="@{/js/common-api.js}"></script>
<script type="module" th:src="@{/js/navbar-auth.js}"></script>

<script type="module" th:inline="javascript">
  import { fetchWithAuth } from '/js/common-api.js';

  //  "ìƒˆ ì½”ë“œ"ì˜ ì„œë²„ ë°ì´í„°
  const isLoggedIn = /*[[${isLoggedIn}]]*/ false;
  const productId = /*[[${product.id}]]*/ null;
  const productPrice = /*[[${product.price}]]*/ 0;

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
  document.addEventListener("DOMContentLoaded", () => {

    // "ìƒˆ ì½”ë“œ"ì˜ ì¿ í° ë¡œì§
    if (isLoggedIn) {
      loadApplicableCoupons();
    }

    // "ìƒˆ ì½”ë“œ"ì˜ ì°œí•˜ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
    const wishlistBtn = document.getElementById('wishlist-btn');
    wishlistBtn.addEventListener('click', () => {
      if (!isLoggedIn) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
        location.href = '/login';
      } else {
        handleLikeProduct();
      }
    });

    // "ì›ë³¸ ì½”ë“œ"ì˜ ì¥ë°”êµ¬ë‹ˆ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById("addToCartBtn").addEventListener("click", async (e) => {
      const productId = e.currentTarget.dataset.productId;

      const quantity = document.getElementById("quantity").value;

      try {
        const response = await fetchWithAuth(`/api/cart/add?productId=${productId}&quantity=${quantity}`, {
          method: "POST"
        });

        if (response.ok) {
          alert("ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤!");
          window.location.href = "/products";
        } else {
          window.location.href = "/login";
        }
      } catch (err) {
        alert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
        window.location.href = "/login";
      }
    });
  });

  // "ìƒˆ ì½”ë“œ"ì˜ ì¿ í° ë¡œë“œ í•¨ìˆ˜
  async function loadApplicableCoupons() {
    const container = document.getElementById('coupon-list-container');
    try {
      const response = await fetchWithAuth(`/api/coupons/applicable-to/${productId}`);
      const coupons = await response.json();

      if (coupons.length === 0) {
        container.innerHTML = `<div class="text-muted p-3">ì ìš© ê°€ëŠ¥í•œ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      container.innerHTML = coupons.map(coupon => `
                <div class="coupon-list-item">
                    <div class="coupon-info">
                        <div class="name">${coupon.name}</div>
                        <div class="condition">${coupon.minOrderAmount}ì› ì´ìƒ êµ¬ë§¤ ì‹œ</div>
                    </div>
                    <div class="coupon-discount">
                        <span class="final-price">
                            ${parseInt(coupon.finalPriceAfterDiscount).toLocaleString()}ì›
                        </span>
                        <small class="text-danger ms-1">(-${parseInt(coupon.calculatedDiscountAmount).toLocaleString()}ì›)</small>
                    </div>
                </div>
            `).join('');

    } catch (error) {
      console.error('ì¿ í° ë¡œë“œ ì‹¤íŒ¨:', error);
      container.innerHTML = `<div class="text-danger p-3">ì¿ í°ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>`;
    }
  }

  // "ìƒˆ ì½”ë“œ"ì˜ "ì¢‹ì•„ìš”" API í˜¸ì¶œ í•¨ìˆ˜
  async function handleLikeProduct() {
    const wishlistBtn = document.getElementById('wishlist-btn');
    try {
      const response = await fetchWithAuth(`/products/${productId}/like`, {
        method: 'POST'
      });
      wishlistBtn.classList.add('active');
      alert('ìƒí’ˆì„ ì°œí–ˆìŠµë‹ˆë‹¤!');

    } catch (error) {
      console.error('ì¢‹ì•„ìš” ì‹¤íŒ¨:', error);
      if (error.message.includes("ì´ë¯¸ ì¢‹ì•„ìš”")) {
        if (confirm('ì´ë¯¸ ì°œí•œ ìƒí’ˆì…ë‹ˆë‹¤. ì°œì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          await handleUnlikeProduct();
        }
      } else {
        alert('ì¢‹ì•„ìš” ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }
  }

  // "ìƒˆ ì½”ë“œ"ì˜ "ì¢‹ì•„ìš” ì·¨ì†Œ" API í˜¸ì¶œ í•¨ìˆ˜
  async function handleUnlikeProduct() {
    const wishlistBtn = document.getElementById('wishlist-btn');
    try {
      await fetchWithAuth(`/products/${productId}/like`, {
        method: 'DELETE'
      });
      wishlistBtn.classList.remove('active');
      alert('ì°œì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.');

    } catch (error) {
      console.error('ì¢‹ì•„ìš” ì·¨ì†Œ ì‹¤íŒ¨:', error);
      alert('ì¢‹ì•„ìš” ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }
</script>

<script th:inline="javascript">
  document.addEventListener("DOMContentLoaded", function () {
    const bundleSelect = document.getElementById("bundle");
    const quantityInput = document.getElementById("quantity");
    const priceDisplay = document.getElementById("bundle-price");

    const unitPrice = /*[[${product.price}]]*/ 0;

    function updatePrice() {
      const bundleCount = parseInt(bundleSelect.value);
      const quantity = parseInt(quantityInput.value);

      // ìˆ˜ëŸ‰ì´ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ 1ë¡œ ê°„ì£¼
      const validQuantity = isNaN(quantity) || quantity < 1 ? 1 : quantity;

      const totalPrice = unitPrice * bundleCount * validQuantity;

      priceDisplay.textContent = `ì´ ê°€ê²©: â‚©${totalPrice.toLocaleString()}`;
    }

    bundleSelect.addEventListener("change", updatePrice);
    quantityInput.addEventListener("input", updatePrice);

    updatePrice(); // ì´ˆê¸° ë¡œë“œ ì‹œ ê°€ê²© ê³„ì‚°
  });
</script>

</body>
</html>